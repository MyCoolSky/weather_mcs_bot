************************************************
Ğ±Ğ¾Ñ‚ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñ‹. Ğ²ĞµÑ€ÑĞ¸Ñ 0.1
************************************************
import requests
from datetime import datetime, timedelta
from telegram import ReplyKeyboardMarkup, Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

TOKEN = "8176736792:AAH1JUJ69_fdg1eQKfbdecqXs7FNOy6tdxE"
WEATHER_API_KEY = "d39c8748686afb6a55befcffbaa16554"

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True,
        one_time_keyboard=True
    )

    await update.message.reply_text(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ğŸ‘‹\n\n"
        "Ğ¯ Ñ‚Ğ²Ğ¾Ğ¹ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº ğŸŒ¤\n"
        "ĞœĞ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ‚ĞµĞ±Ğµ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ² Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğµ.\n\n"
        "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«Ğ¡Ñ‚Ğ°Ñ€Ñ‚Â» ğŸ‘‡",
        reply_markup=reply_markup
    )


# ĞºĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ñ‚Ğ°Ñ€Ñ‚"
async def handle_start_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ğŸ‘\n\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°, Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ´Ğ»Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ñ‚Ñ‹ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ ğŸŒ"
    )


# Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ° (Ğ³Ğ¾Ñ€Ğ¾Ğ´)
async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = update.message.text
    context.user_data["city"] = city

    url = (
        "https://api.openweathermap.org/data/2.5/weather"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )

    response = requests.get(url)
    data = response.json()

    if response.status_code != 200:
        await update.message.reply_text(
            "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ‚Ğ°ĞºĞ¾Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸ˜”\n"
            "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·."
        )
        return

    temp = round(data["main"]["temp"])
    feels_like = round(data["main"]["feels_like"])
    humidity = data["main"]["humidity"]
    description = data["weather"][0]["description"]
    city_name = data["name"]

    await update.message.reply_text(
            f"Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ğ» Ğ³Ğ¾Ñ€Ğ¾Ğ´: {city_name} ğŸŒ"
        )

    await show_menu(update, context)

    text = (
        f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ² {city_name}\n"
        f"{description.capitalize()}\n\n"
        f"ğŸŒ¡ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°: {temp}Â°C\n"
        f"ğŸ¤— ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº: {feels_like}Â°C\n"
        f"ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ: {humidity}%"
    )

    await update.message.reply_text(text)
    

# /weather (Ğ¿Ğ¾ Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ñ, Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ)
async def weather(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = " ".join(context.args) if context.args else "Warsaw"
    context.args = [city]
    await echo(update, context)

# /function show menu
async def show_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        ["ğŸŒ¤ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°"],
        ["ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ"],
        ["ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]
    ]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True
    )

    await update.message.reply_text(
        "Ğ§Ñ‚Ğ¾ Ñ‚ĞµĞ±Ñ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑƒĞµÑ‚? ğŸ‘‡",
        reply_markup=reply_markup
    )

from datetime import datetime, timedelta

async def handle_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    city = context.user_data.get("city")

    if not city:
        await update.message.reply_text("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")
        return

    # ================== Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯ ==================
    if text == "ğŸŒ¤ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        message = f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² {city}\n\n"
        for item in data["list"][:6]:  # ~18 Ñ‡Ğ°ÑĞ¾Ğ² Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´
            time = item["dt_txt"][11:16]
            temp = round(item["main"]["temp"])
            desc = item["weather"][0]["description"]
            message += f"ğŸ•’ {time} â€” {temp}Â°C, {desc}\n"

        await update.message.reply_text(message)

    # ================== Ğ—ĞĞ’Ğ¢Ğ Ğ ==================
    elif text == "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        tomorrow = (datetime.now() + timedelta(days=1)).strftime("%Y-%m-%d")

        temps = []
        descriptions = []

        for item in data["list"]:
            if item["dt_txt"].startswith(tomorrow):
                temps.append(item["main"]["temp"])
                descriptions.append(item["weather"][0]["description"])

        if not temps:
            await update.message.reply_text("ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° ğŸ˜•")
            return

        avg_temp = round(sum(temps) / len(temps))
        main_desc = max(set(descriptions), key=descriptions.count)

        message = (
            f"â˜€ï¸ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ² {city}\n\n"
            f"ğŸŒ¡ Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°: {avg_temp}Â°C\n"
            f"ğŸŒ¥ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: {main_desc}"
        )

        await update.message.reply_text(message)

    # ================== ĞĞ 3 Ğ”ĞĞ¯ ==================
    elif text == "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        message = f"ğŸ“… ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° 3 Ğ´Ğ½Ñ Ğ´Ğ»Ñ {city}\n\n"
        days = {}

        for item in data["list"]:
            date = item["dt_txt"].split(" ")[0]
            temp = round(item["main"]["temp"])
            days.setdefault(date, []).append(temp)

        for date, temps in list(days.items())[:3]:
            avg_temp = round(sum(temps) / len(temps))
            message += f"ğŸ“† {date} â€” ~{avg_temp}Â°C\n"

        await update.message.reply_text(message)

    # ================== Ğ¡ĞœĞ•ĞĞ˜Ğ¢Ğ¬ Ğ“ĞĞ ĞĞ” ==================
    elif text == "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´":
        context.user_data.pop("city", None)
        await update.message.reply_text("Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ ğŸ™‚ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")

def get_forecast(city: str):
    url = (
        "https://api.openweathermap.org/data/2.5/forecast"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )
    response = requests.get(url)
    if response.status_code != 200:
        return None
    return response.json()
    
if __name__ == "__main__":
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Text(["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]), handle_start_button))
    app.add_handler(CommandHandler("weather", weather))
    app.add_handler(MessageHandler(filters.Text(["ğŸŒ¤ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°", "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ", "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]),handle_menu))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo))

    app.run_polling()


****************
Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•
******************
import requests
from datetime import datetime, timedelta
from telegram import ReplyKeyboardMarkup, Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

TOKEN = "8176736792:AAH1JUJ69_fdg1eQKfbdecqXs7FNOy6tdxE"
WEATHER_API_KEY = "d39c8748686afb6a55befcffbaa16554"

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True,
        one_time_keyboard=True
    )

    await update.message.reply_text(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ğŸ‘‹\n\n"
        "Ğ¯ Ñ‚Ğ²Ğ¾Ğ¹ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº ğŸŒ¤\n"
        "ĞœĞ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ‚ĞµĞ±Ğµ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ² Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğµ.\n\n"
        "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«Ğ¡Ñ‚Ğ°Ñ€Ñ‚Â» ğŸ‘‡",
        reply_markup=reply_markup
    )


# ĞºĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ñ‚Ğ°Ñ€Ñ‚"
async def handle_start_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ğŸ‘\n\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°, Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ´Ğ»Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ñ‚Ñ‹ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ ğŸŒ"
    )


# Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ° (Ğ³Ğ¾Ñ€Ğ¾Ğ´)
async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = update.message.text
    context.user_data["city"] = city

    url = (
        "https://api.openweathermap.org/data/2.5/weather"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )

    response = requests.get(url)
    data = response.json()

    if response.status_code != 200:
        await update.message.reply_text(
            "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ‚Ğ°ĞºĞ¾Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸ˜”\n"
            "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·."
        )
        return

    temp = round(data["main"]["temp"])
    feels_like = round(data["main"]["feels_like"])
    humidity = data["main"]["humidity"]
    description = data["weather"][0]["description"]
    city_name = data["name"]

    await update.message.reply_text(
            f"Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ğ» Ğ³Ğ¾Ñ€Ğ¾Ğ´: {city_name} ğŸŒ"
        )

    await show_menu(update, context)

    text = (
        f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ² {city_name}\n"
        f"{description.capitalize()}\n\n"
        f"ğŸŒ¡ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°: {temp}Â°C\n"
        f"ğŸ¤— ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº: {feels_like}Â°C\n"
        f"ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ: {humidity}%"
    )

    await update.message.reply_text(text)
    

# /weather (Ğ¿Ğ¾ Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ñ, Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ)
async def weather(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = " ".join(context.args) if context.args else "Warsaw"
    context.args = [city]
    await echo(update, context)

# /function show menu
async def show_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        ["ğŸŒ¤ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°"],
        ["ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ"],
        ["ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]
    ]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True
    )

    await update.message.reply_text(
        "Ğ§Ñ‚Ğ¾ Ñ‚ĞµĞ±Ñ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑƒĞµÑ‚? ğŸ‘‡",
        reply_markup=reply_markup
    )

from datetime import datetime, timedelta

async def handle_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    city = context.user_data.get("city")

    if not city:
        await update.message.reply_text("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")
        return

    # ================== Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯ ==================
    if text == "ğŸŒ¤ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        message = f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² {city}\n\n"
        for item in data["list"][:6]:
            time = item["dt_txt"][11:16]
            temp = round(item["main"]["temp"])
            desc = item["weather"][0]["description"]
            message += f"ğŸ•’ {time} â€” {temp}Â°C, {desc}\n"

        await update.message.reply_text(message)

    # ================== Ğ—ĞĞ’Ğ¢Ğ Ğ ==================
    elif text == "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        tomorrow = (datetime.now() + timedelta(days=1)).strftime("%Y-%m-%d")
        target_hours = ["06:00", "09:00", "12:00", "15:00", "18:00", "21:00"]

        message = f"ğŸŒ… ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ² {city}\n\n"

        for item in data["list"]:
            date, time = item["dt_txt"].split(" ")
            if date == tomorrow and time[:5] in target_hours:
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                message += f"ğŸ•’ {time[:5]} â€” {temp}Â°C, {desc}\n"

        await update.message.reply_text(message)

    # ================== ĞĞ 3 Ğ”ĞĞ¯ ==================
    elif text == "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        days = {}
        target_hours = ["06:00", "12:00", "18:00"]

        for item in data["list"]:
            date, time = item["dt_txt"].split(" ")
            if time[:5] in target_hours:
                days.setdefault(date, []).append(item)

        message = f"ğŸ“… ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° 3 Ğ´Ğ½Ñ Ğ´Ğ»Ñ {city}\n\n"

        for date, items in list(days.items())[:3]:
            day_name = datetime.strptime(date, "%Y-%m-%d").strftime("%A")
            message += f"ğŸ“† {date} ({day_name})\n"

            for item in items:
                time = item["dt_txt"][11:16]
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                message += f"   â€¢ {time} â€” {desc}, {temp}Â°C\n"

            message += "\n"

        await update.message.reply_text(message)

    # ================== Ğ¡ĞœĞ•ĞĞ˜Ğ¢Ğ¬ Ğ“ĞĞ ĞĞ” ==================
    elif text == "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´":
        context.user_data.pop("city", None)
        await update.message.reply_text("Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ ğŸ™‚ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")

def get_forecast(city: str):
    url = (
        "https://api.openweathermap.org/data/2.5/forecast"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )
    response = requests.get(url)
    if response.status_code != 200:
        return None
    return response.json()
    
if __name__ == "__main__":
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Text(["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]), handle_start_button))
    app.add_handler(CommandHandler("weather", weather))
    app.add_handler(MessageHandler(filters.Text(["ğŸŒ¤ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°", "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ", "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]),handle_menu))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo))

    app.run_polling()

************************
27.01.2026 21:17
*************************
import requests
from datetime import datetime, timedelta
from telegram import ReplyKeyboardMarkup, Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

TOKEN = "8176736792:AAH1JUJ69_fdg1eQKfbdecqXs7FNOy6tdxE"
WEATHER_API_KEY = "d39c8748686afb6a55befcffbaa16554"

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True,
        one_time_keyboard=True
    )

    await update.message.reply_text(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ğŸ‘‹\n\n"
        "Ğ¯ Ğ’Ğ°Ñˆ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº ğŸŒ¤\n"
        "ĞœĞ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ’Ğ°Ğ¼ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ² Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğµ.\n\n"
        "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«Ğ¡Ñ‚Ğ°Ñ€Ñ‚Â» ğŸ‘‡",
        reply_markup=reply_markup
    )


# ĞºĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ñ‚Ğ°Ñ€Ñ‚"
async def handle_start_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ğŸ‘\n\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°, Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ´Ğ»Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ñ‚Ñ‹ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ ğŸŒ"
    )


# Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ° (Ğ³Ğ¾Ñ€Ğ¾Ğ´)
async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = update.message.text
    context.user_data["city"] = city

    url = (
        "https://api.openweathermap.org/data/2.5/weather"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )

    response = requests.get(url)
    data = response.json()

    if response.status_code != 200:
        await update.message.reply_text(
            "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ‚Ğ°ĞºĞ¾Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸ˜”\n"
            "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·."
        )
        return

    temp = round(data["main"]["temp"])
    feels_like = round(data["main"]["feels_like"])
    humidity = data["main"]["humidity"]
    description = data["weather"][0]["description"]
    city_name = data["name"]

    await update.message.reply_text(
            f"Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ğ» Ğ³Ğ¾Ñ€Ğ¾Ğ´: {city_name} ğŸŒ"
        )

    await show_menu(update, context)

    text = (
        f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ² {city_name}\n"
        f"{description.capitalize()}\n\n"
        f"ğŸŒ¡ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°: {temp}Â°C\n"
        f"ğŸ¤— ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº: {feels_like}Â°C\n"
        f"ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ: {humidity}%"
    )

    await update.message.reply_text(text)
    

# /weather (Ğ¿Ğ¾ Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ñ, Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ)
async def weather(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = " ".join(context.args) if context.args else "London"
    context.args = [city]
    await echo(update, context)

# /function show menu
async def show_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        ["ğŸŒ¤ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°"],
        ["ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ"],
        ["ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]
    ]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True
    )

    await update.message.reply_text(
        "Ğ§Ñ‚Ğ¾ Ğ’Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑƒĞµÑ‚? ğŸ‘‡",
        reply_markup=reply_markup
    )

from datetime import datetime, timedelta

async def handle_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    city = context.user_data.get("city")

    if not city:
        await update.message.reply_text("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")
        return

    # ================== Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯ ==================
    if text == "ğŸŒ¤ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        current = data["list"][0]

        smart_text = smart_weather_text(
            temp=round(current["main"]["temp"]),
            feels_like=round(current["main"]["feels_like"]),
            description=current["weather"][0]["description"],
            wind_speed=current["wind"]["speed"],
            day="ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ"
        )
        await update.message.reply_text(smart_text)

        message = f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² {city}\n\n"
        for item in data["list"][:6]:
            time = item["dt_txt"][11:16]
            temp = round(item["main"]["temp"])
            desc = item["weather"][0]["description"]
            message += f"ğŸ•’ {time} â€” {temp}Â°C, {desc}\n"

        await update.message.reply_text(message)

    # ================== Ğ—ĞĞ’Ğ¢Ğ Ğ ==================
    elif text == "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        tomorrow_date = (datetime.now() + timedelta(days=1)).strftime("%Y-%m-%d")
        target_hours = ["06:00", "09:00", "12:00", "15:00", "18:00", "21:00"]

        tomorrow_items = [
            item for item in data["list"]
            if item["dt_txt"].startswith(tomorrow_date)
        ]

        if not tomorrow_items:
            await update.message.reply_text("ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° ğŸ˜•")
            return

        main_item = tomorrow_items[len(tomorrow_items) // 2]

        smart_text = smart_weather_text(
            temp=round(main_item["main"]["temp"]),
            feels_like=round(main_item["main"]["feels_like"]),
            description=main_item["weather"][0]["description"],
            wind_speed=main_item["wind"]["speed"],
            day="Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°"
        )
        await update.message.reply_text(smart_text)

        message = f"ğŸŒ… ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ² {city}\n\n"
        for item in tomorrow_items:
            time = item["dt_txt"][11:16]
            if time in target_hours:
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                message += f"ğŸ•’ {time} â€” {temp}Â°C, {desc}\n"

        await update.message.reply_text(message)

    # ================== ĞĞ 3 Ğ”ĞĞ¯ ==================
    elif text == "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        days = {}
        target_hours = ["06:00", "12:00", "18:00"]

        for item in data["list"]:
            date, time = item["dt_txt"].split(" ")
            if time[:5] in target_hours:
                days.setdefault(date, []).append(item)

        message = f"ğŸ“… ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° 3 Ğ´Ğ½Ñ Ğ´Ğ»Ñ {city}\n\n"

        for date, items in list(days.items())[:3]:
            day_name = datetime.strptime(date, "%Y-%m-%d").strftime("%A")
            message += f"ğŸ“† {date} ({day_name})\n"

            for item in items:
                time = item["dt_txt"][11:16]
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                message += f"   â€¢ {time} â€” {desc}, {temp}Â°C\n"

            message += "\n"

        await update.message.reply_text(message)

    # ================== Ğ¡ĞœĞ•ĞĞ˜Ğ¢Ğ¬ Ğ“ĞĞ ĞĞ” ==================
    elif text == "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´":
        context.user_data.pop("city", None)
        await update.message.reply_text("Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ ğŸ™‚ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")

def smart_weather_text(temp, feels_like, description, wind_speed=None, day="ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ"):
    text = f"ğŸ§  Ğ§Ñ‚Ğ¾ Ğ¿Ğ¾ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸ÑĞ¼ {day}:\n"

    # Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°
    if temp <= 0:
        text += "â„ï¸ ĞÑ‡ĞµĞ½ÑŒ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾. "
    elif 1 <= temp <= 7:
        text += "ğŸ§¥ ĞŸÑ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ½Ğ¾. "
    elif 8 <= temp <= 15:
        text += "ğŸ™‚ ĞšĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚Ğ½Ğ¾, Ğ½Ğ¾ Ğ±ĞµĞ· Ğ¶Ğ°Ñ€Ñ‹. "
    elif 16 <= temp <= 25:
        text += "ğŸ˜Œ Ğ¢ĞµĞ¿Ğ»Ğ¾ Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾. "
    else:
        text += "ğŸ”¥ Ğ–Ğ°Ñ€ĞºĞ¾. "

    # ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº
    if feels_like < temp - 2:
        text += "ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ½Ğ¾ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½ĞµĞµ. "
    elif feels_like > temp + 2:
        text += "ĞŸĞ¾ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸ÑĞ¼ Ñ‚ĞµĞ¿Ğ»ĞµĞµ, Ñ‡ĞµĞ¼ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚ĞµÑ€Ğ¼Ğ¾Ğ¼ĞµÑ‚Ñ€. "

    # ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñ‹
    if "Ğ´Ğ¾Ğ¶Ğ´ÑŒ" in description:
        text += "ğŸŒ§ Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹ Ğ¾ÑĞ°Ğ´ĞºĞ¸ â€” Ğ·Ğ¾Ğ½Ñ‚ Ğ±ÑƒĞ´ĞµÑ‚ ĞºÑÑ‚Ğ°Ñ‚Ğ¸. "
    elif "ÑĞ½ĞµĞ³" in description:
        text += "â„ï¸ Ğ¡Ğ½ĞµĞ³ â€” Ğ±ÑƒĞ´ÑŒ Ğ¾ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶ĞµĞ½ Ğ½Ğ° Ğ´Ğ¾Ñ€Ğ¾Ğ³Ğµ. "
    elif "Ğ¾Ğ±Ğ»Ğ°Ğº" in description:
        text += "â˜ï¸ ĞŸĞ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾, ÑĞ¾Ğ»Ğ½Ñ†Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€ÑÑ‚Ğ°Ñ‚ÑŒÑÑ. "
    elif "ÑÑĞ½Ğ¾" in description:
        text += "â˜€ï¸ Ğ¯ÑĞ½Ğ¾ Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾. "

    # Ğ’ĞµÑ‚ĞµÑ€
    if wind_speed:
        if wind_speed >= 8:
            text += "ğŸ’¨ Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²ĞµÑ‚ĞµÑ€ ÑƒÑĞ¸Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸Ñ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ°."
        elif wind_speed >= 4:
            text += "ğŸŒ¬ Ğ£Ğ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ‚ĞµÑ€."
    
    return text


def get_forecast(city: str):
    url = (
        "https://api.openweathermap.org/data/2.5/forecast"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )
    response = requests.get(url)
    if response.status_code != 200:
        return None
    return response.json()
    
if __name__ == "__main__":
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Text(["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]), handle_start_button))
    app.add_handler(CommandHandler("weather", weather))
    app.add_handler(MessageHandler(filters.Text(["ğŸŒ¤ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°", "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ", "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]),handle_menu))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo))

    app.run_polling()
**************************************
Ğ½Ğ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ - Ğ²ĞµĞ¶Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ
**************************************
import requests
from datetime import datetime, timedelta
from telegram import ReplyKeyboardMarkup, Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

TOKEN = "8176736792:AAH1JUJ69_fdg1eQKfbdecqXs7FNOy6tdxE"
WEATHER_API_KEY = "d39c8748686afb6a55befcffbaa16554"

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True,
        one_time_keyboard=True
    )

    await update.message.reply_text(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ğŸ‘‹\n\n"
        "Ğ¯ Ğ’Ğ°Ñˆ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº ğŸŒ¤\n"
        "ĞœĞ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ’Ğ°Ğ¼ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ² Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğµ.\n\n"
        "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«Ğ¡Ñ‚Ğ°Ñ€Ñ‚Â» ğŸ‘‡",
        reply_markup=reply_markup
    )


# ĞºĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ñ‚Ğ°Ñ€Ñ‚"
async def handle_start_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ğŸ‘\n\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°, Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ´Ğ»Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ’Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ ğŸŒ"
    )


# Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ° (Ğ³Ğ¾Ñ€Ğ¾Ğ´)
async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = update.message.text
    context.user_data["city"] = city

    url = (
        "https://api.openweathermap.org/data/2.5/weather"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )

    response = requests.get(url)
    data = response.json()

    if response.status_code != 200:
        await update.message.reply_text(
            "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ‚Ğ°ĞºĞ¾Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸ˜”\n"
            "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·."
        )
        return

    temp = round(data["main"]["temp"])
    feels_like = round(data["main"]["feels_like"])
    humidity = data["main"]["humidity"]
    description = data["weather"][0]["description"]
    city_name = data["name"]

    await update.message.reply_text(
            f"Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ğ» Ğ³Ğ¾Ñ€Ğ¾Ğ´: {city_name} ğŸŒ"
        )

    await show_menu(update, context)

    text = (
        f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ² {city_name}\n"
        f"{description.capitalize()}\n\n"
        f"ğŸŒ¡ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°: {temp}Â°C\n"
        f"ğŸ¤— ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº: {feels_like}Â°C\n"
        f"ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ: {humidity}%"
        f"â„¹ï¸ Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸ â€” Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿ÑƒĞ½ĞºÑ‚ Ğ½Ğ¸Ğ¶Ğµ ğŸ‘‡"
    )

    await update.message.reply_text(text)
    

# /weather (Ğ¿Ğ¾ Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ñ, Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ)
async def weather(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = " ".join(context.args) if context.args else "London"
    context.args = [city]
    await echo(update, context)

# /function show menu
async def show_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        ["ğŸ“Š Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°"],
        ["ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ"],
        ["ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]
    ]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True
    )

    await update.message.reply_text(
        "Ğ§Ñ‚Ğ¾ Ğ’Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑƒĞµÑ‚? ğŸ‘‡",
        reply_markup=reply_markup
    )

from datetime import datetime, timedelta

async def handle_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    city = context.user_data.get("city")

    if not city:
        await update.message.reply_text("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")
        return

    # ================== Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯ ==================
    if text == "ğŸ“Š Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        current = data["list"][0]

        smart_text = smart_weather_text(
            temp=round(current["main"]["temp"]),
            feels_like=round(current["main"]["feels_like"]),
            description=current["weather"][0]["description"],
            wind_speed=current["wind"]["speed"],
            day="ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ"
        )
        await update.message.reply_text(smart_text)

        message = f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² {city}\n\n"
        for item in data["list"][:6]:
            time = item["dt_txt"][11:16]
            temp = round(item["main"]["temp"])
            desc = item["weather"][0]["description"]
            message += f"ğŸ•’ {time} â€” {temp}Â°C, {desc}\n"

        await update.message.reply_text(message)

    # ================== Ğ—ĞĞ’Ğ¢Ğ Ğ ==================
    elif text == "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        tomorrow_date = (datetime.now() + timedelta(days=1)).strftime("%Y-%m-%d")
        target_hours = ["06:00", "09:00", "12:00", "15:00", "18:00", "21:00"]

        tomorrow_items = [
            item for item in data["list"]
            if item["dt_txt"].startswith(tomorrow_date)
        ]

        if not tomorrow_items:
            await update.message.reply_text("ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° ğŸ˜•")
            return

        main_item = tomorrow_items[len(tomorrow_items) // 2]

        smart_text = smart_weather_text(
            temp=round(main_item["main"]["temp"]),
            feels_like=round(main_item["main"]["feels_like"]),
            description=main_item["weather"][0]["description"],
            wind_speed=main_item["wind"]["speed"],
            day="Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°"
        )
        await update.message.reply_text(smart_text)

        message = f"ğŸŒ… ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ² {city}\n\n"
        for item in tomorrow_items:
            time = item["dt_txt"][11:16]
            if time in target_hours:
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                message += f"ğŸ•’ {time} â€” {temp}Â°C, {desc}\n"

        await update.message.reply_text(message)

    # ================== ĞĞ 3 Ğ”ĞĞ¯ ==================
    elif text == "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        days = {}
        target_hours = ["06:00", "12:00", "18:00"]

        for item in data["list"]:
            date, time = item["dt_txt"].split(" ")
            if time[:5] in target_hours:
                days.setdefault(date, []).append(item)

        message = f"ğŸ“… ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° 3 Ğ´Ğ½Ñ Ğ´Ğ»Ñ {city}\n\n"

        for date, items in list(days.items())[:3]:
            day_name = datetime.strptime(date, "%Y-%m-%d").strftime("%A")
            message += f"ğŸ“† {date} ({day_name})\n"

            for item in items:
                time = item["dt_txt"][11:16]
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                message += f"   â€¢ {time} â€” {desc}, {temp}Â°C\n"

            message += "\n"

        await update.message.reply_text(message)

    # ================== Ğ¡ĞœĞ•ĞĞ˜Ğ¢Ğ¬ Ğ“ĞĞ ĞĞ” ==================
    elif text == "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´":
        context.user_data.pop("city", None)
        await update.message.reply_text("Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ ğŸ™‚ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")

def smart_weather_text(temp, feels_like, description, wind_speed=None, day="ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ"):
    text = f"ğŸ§  Ğ§Ñ‚Ğ¾ Ğ¿Ğ¾ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸ÑĞ¼ {day}:\n"

    # Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°
    if temp <= 0:
        text += "â„ï¸ ĞÑ‡ĞµĞ½ÑŒ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾. "
    elif 1 <= temp <= 7:
        text += "ğŸ§¥ ĞŸÑ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ½Ğ¾. "
    elif 8 <= temp <= 15:
        text += "ğŸ™‚ ĞšĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚Ğ½Ğ¾, Ğ½Ğ¾ Ğ±ĞµĞ· Ğ¶Ğ°Ñ€Ñ‹. "
    elif 16 <= temp <= 25:
        text += "ğŸ˜Œ Ğ¢ĞµĞ¿Ğ»Ğ¾ Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾. "
    else:
        text += "ğŸ”¥ Ğ–Ğ°Ñ€ĞºĞ¾. "

    # ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº
    if feels_like < temp - 2:
        text += "ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ½Ğ¾ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½ĞµĞµ. "
    elif feels_like > temp + 2:
        text += "ĞŸĞ¾ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸ÑĞ¼ Ñ‚ĞµĞ¿Ğ»ĞµĞµ, Ñ‡ĞµĞ¼ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚ĞµÑ€Ğ¼Ğ¾Ğ¼ĞµÑ‚Ñ€. "

    # ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñ‹
    if "Ğ´Ğ¾Ğ¶Ğ´ÑŒ" in description:
        text += "ğŸŒ§ Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹ Ğ¾ÑĞ°Ğ´ĞºĞ¸ â€” Ğ·Ğ¾Ğ½Ñ‚ Ğ±ÑƒĞ´ĞµÑ‚ ĞºÑÑ‚Ğ°Ñ‚Ğ¸. "
    elif "ÑĞ½ĞµĞ³" in description:
        text += "â„ï¸ Ğ¡Ğ½ĞµĞ³ â€” Ğ±ÑƒĞ´ÑŒ Ğ¾ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶ĞµĞ½ Ğ½Ğ° Ğ´Ğ¾Ñ€Ğ¾Ğ³Ğµ. "
    elif "Ğ¾Ğ±Ğ»Ğ°Ğº" in description:
        text += "â˜ï¸ ĞŸĞ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾, ÑĞ¾Ğ»Ğ½Ñ†Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€ÑÑ‚Ğ°Ñ‚ÑŒÑÑ. "
    elif "ÑÑĞ½Ğ¾" in description:
        text += "â˜€ï¸ Ğ¯ÑĞ½Ğ¾ Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾. "

    # Ğ’ĞµÑ‚ĞµÑ€
    if wind_speed:
        if wind_speed >= 8:
            text += "ğŸ’¨ Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²ĞµÑ‚ĞµÑ€ ÑƒÑĞ¸Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸Ñ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ°."
        elif wind_speed >= 4:
            text += "ğŸŒ¬ Ğ£Ğ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ‚ĞµÑ€."
    
    return text


def get_forecast(city: str):
    url = (
        "https://api.openweathermap.org/data/2.5/forecast"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )
    response = requests.get(url)
    if response.status_code != 200:
        return None
    return response.json()
    
if __name__ == "__main__":
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Text(["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]), handle_start_button))
    app.add_handler(CommandHandler("weather", weather))
    app.add_handler(MessageHandler(filters.Text(["ğŸŒ¤ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°", "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ", "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]),handle_menu))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo))

    app.run_polling()

******************************************
Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ. Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
******************************************
import requests
from datetime import datetime, timedelta
from telegram import ReplyKeyboardMarkup, Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

TOKEN = "8176736792:AAH1JUJ69_fdg1eQKfbdecqXs7FNOy6tdxE"
WEATHER_API_KEY = "d39c8748686afb6a55befcffbaa16554"

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True,
        one_time_keyboard=True
    )

    await update.message.reply_text(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ğŸ‘‹\n\n"
        "Ğ¯ Ğ’Ğ°Ñˆ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº ğŸŒ¤\n"
        "ĞœĞ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ’Ğ°Ğ¼ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ² Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğµ.\n\n"
        "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«Ğ¡Ñ‚Ğ°Ñ€Ñ‚Â» ğŸ‘‡",
        reply_markup=reply_markup
    )


# ĞºĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ñ‚Ğ°Ñ€Ñ‚"
async def handle_start_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ğŸ‘\n\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°, Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ´Ğ»Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ’Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ ğŸŒ"
    )


# Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ° (Ğ³Ğ¾Ñ€Ğ¾Ğ´)
async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = update.message.text
    context.user_data["city"] = city

    url = (
        "https://api.openweathermap.org/data/2.5/weather"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )

    response = requests.get(url)
    data = response.json()

    if response.status_code != 200:
        await update.message.reply_text(
            "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ‚Ğ°ĞºĞ¾Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸ˜”\n"
            "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·."
        )
        return

    temp = round(data["main"]["temp"])
    feels_like = round(data["main"]["feels_like"])
    humidity = data["main"]["humidity"]
    description = data["weather"][0]["description"]
    city_name = data["name"]

    await update.message.reply_text(
            f"Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ğ» Ğ³Ğ¾Ñ€Ğ¾Ğ´: {city_name} ğŸŒ"
        )

    await show_menu(update, context)

    text = (
        f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ² {city_name}\n"
        f"{description.capitalize()}\n\n"
        f"ğŸŒ¡ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°: {temp}Â°C\n"
        f"ğŸ¤— ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº: {feels_like}Â°C\n"
        f"ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ: {humidity}%\n\n"
        f"â„¹ï¸ Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸ â€” Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿ÑƒĞ½ĞºÑ‚ Ğ½Ğ¸Ğ¶Ğµ ğŸ‘‡"
    )

    await update.message.reply_text(text)
    

# /weather (Ğ¿Ğ¾ Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ñ, Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ)
async def weather(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = " ".join(context.args) if context.args else "London"
    context.args = [city]
    await echo(update, context)

# /function show menu
async def show_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        ["ğŸ“Š Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°"],
        ["ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ"],
        ["ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]
    ]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True
    )

    await update.message.reply_text(
        "Ğ§Ñ‚Ğ¾ Ğ’Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑƒĞµÑ‚? ğŸ‘‡",
        reply_markup=reply_markup
    )

from datetime import datetime, timedelta

async def handle_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    city = context.user_data.get("city", "").title()

    if not city:
        await update.message.reply_text("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")
        return

    # ================== Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯ ==================
    if text == "ğŸ“Š Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        current = data["list"][0]

        smart_text = smart_weather_text(
            temp=round(current["main"]["temp"]),
            feels_like=round(current["main"]["feels_like"]),
            description=current["weather"][0]["description"],
            wind_speed=current["wind"]["speed"],
            day="ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ"
        )
        await update.message.reply_text(smart_text)

        message = f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² {city}\n\n"
        for item in data["list"][:6]:
            time = item["dt_txt"][11:16]
            temp = round(item["main"]["temp"])
            desc = item["weather"][0]["description"]
            message += f"ğŸ•’ {time} â€” {temp}Â°C, {desc}\n"

        await update.message.reply_text(message)

    # ================== Ğ—ĞĞ’Ğ¢Ğ Ğ ==================
    elif text == "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        tomorrow_date = (datetime.now() + timedelta(days=1)).strftime("%Y-%m-%d")
        target_hours = ["06:00", "09:00", "12:00", "15:00", "18:00", "21:00"]

        tomorrow_items = [
            item for item in data["list"]
            if item["dt_txt"].startswith(tomorrow_date)
        ]

        if not tomorrow_items:
            await update.message.reply_text("ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° ğŸ˜•")
            return

        main_item = tomorrow_items[len(tomorrow_items) // 2]

        smart_text = smart_weather_text(
            temp=round(main_item["main"]["temp"]),
            feels_like=round(main_item["main"]["feels_like"]),
            description=main_item["weather"][0]["description"],
            wind_speed=main_item["wind"]["speed"],
            day="Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°"
        )
        await update.message.reply_text(smart_text)

        message = f"ğŸŒ… ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ² {city}\n\n"
        for item in tomorrow_items:
            time = item["dt_txt"][11:16]
            if time in target_hours:
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                message += f"ğŸ•’ {time} â€” {temp}Â°C, {desc}\n"

        await update.message.reply_text(message)

    # ================== ĞĞ 3 Ğ”ĞĞ¯ ==================
    elif text == "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        days = {}
        target_hours = ["06:00", "12:00", "18:00"]

        for item in data["list"]:
            date, time = item["dt_txt"].split(" ")
            if time[:5] in target_hours:
                days.setdefault(date, []).append(item)

        message = f"ğŸ“… ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° 3 Ğ´Ğ½Ñ Ğ´Ğ»Ñ {city}\n\n"

        for date, items in list(days.items())[:3]:
            day_name = datetime.strptime(date, "%Y-%m-%d").strftime("%A")
            message += f"ğŸ“† {date} ({day_name})\n"

            for item in items:
                time = item["dt_txt"][11:16]
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                message += f"   â€¢ {time} â€” {desc}, {temp}Â°C\n"

            message += "\n"

        await update.message.reply_text(message)

    # ================== Ğ¡ĞœĞ•ĞĞ˜Ğ¢Ğ¬ Ğ“ĞĞ ĞĞ” ==================
    elif text == "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´":
        context.user_data.pop("city", None)
        await update.message.reply_text("Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ ğŸ™‚ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")

def smart_weather_text(temp, feels_like, description, wind_speed=None, day="ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ"):
    text = f"ğŸ§  Ğ§Ñ‚Ğ¾ Ğ¿Ğ¾ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸ÑĞ¼ {day}:\n"

    # Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°
    if temp <= 0:
        text += "â„ï¸ ĞÑ‡ĞµĞ½ÑŒ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾. "
    elif 1 <= temp <= 7:
        text += "ğŸ§¥ ĞŸÑ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ½Ğ¾. "
    elif 8 <= temp <= 15:
        text += "ğŸ™‚ ĞšĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚Ğ½Ğ¾, Ğ½Ğ¾ Ğ±ĞµĞ· Ğ¶Ğ°Ñ€Ñ‹. "
    elif 16 <= temp <= 25:
        text += "ğŸ˜Œ Ğ¢ĞµĞ¿Ğ»Ğ¾ Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾. "
    else:
        text += "ğŸ”¥ Ğ–Ğ°Ñ€ĞºĞ¾. "

    # ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº
    if feels_like < temp - 2:
        text += "ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ½Ğ¾ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½ĞµĞµ. "
    elif feels_like > temp + 2:
        text += "ĞŸĞ¾ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸ÑĞ¼ Ñ‚ĞµĞ¿Ğ»ĞµĞµ, Ñ‡ĞµĞ¼ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚ĞµÑ€Ğ¼Ğ¾Ğ¼ĞµÑ‚Ñ€. "

    # ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñ‹
    if "Ğ´Ğ¾Ğ¶Ğ´ÑŒ" in description:
        text += "ğŸŒ§ Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹ Ğ¾ÑĞ°Ğ´ĞºĞ¸ â€” Ğ·Ğ¾Ğ½Ñ‚ Ğ±ÑƒĞ´ĞµÑ‚ ĞºÑÑ‚Ğ°Ñ‚Ğ¸. "
    elif "ÑĞ½ĞµĞ³" in description:
        text += "â„ï¸ Ğ¡Ğ½ĞµĞ³ â€” Ğ±ÑƒĞ´ÑŒ Ğ¾ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶ĞµĞ½ Ğ½Ğ° Ğ´Ğ¾Ñ€Ğ¾Ğ³Ğµ. "
    elif "Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ğ¾" in description:
        text += "â˜ï¸ ĞŸĞ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾, ÑĞ¾Ğ»Ğ½Ñ†Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€ÑÑ‚Ğ°Ñ‚ÑŒÑÑ. "
    elif "ÑÑĞ½Ğ¾" in description:
        text += "â˜€ï¸ Ğ¯ÑĞ½Ğ¾ Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾. "

    # Ğ’ĞµÑ‚ĞµÑ€
    if wind_speed:
        if wind_speed >= 8:
            text += "ğŸ’¨ Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²ĞµÑ‚ĞµÑ€ ÑƒÑĞ¸Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸Ñ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ°."
        elif wind_speed >= 4:
            text += "ğŸŒ¬ Ğ£Ğ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ‚ĞµÑ€."
    
    return text


def get_forecast(city: str):
    url = (
        "https://api.openweathermap.org/data/2.5/forecast"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )
    response = requests.get(url)
    if response.status_code != 200:
        return None
    return response.json()
    
if __name__ == "__main__":
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Text(["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]), handle_start_button))
    app.add_handler(CommandHandler("weather", weather))
    app.add_handler(MessageHandler(filters.Text(["ğŸ“Š Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°", "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ", "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]),handle_menu))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo))

    app.run_polling()


*******************************************
Ğ±Ğ¾Ñ‚ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñ‹, 27.01 Ğ²ĞµÑ€ÑĞ¸Ñ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ Ğ´ĞµĞ½ÑŒ
*********************************************

import requests
from datetime import datetime, timedelta
from telegram import ReplyKeyboardMarkup, Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

TOKEN = "8176736792:AAH1JUJ69_fdg1eQKfbdecqXs7FNOy6tdxE"
WEATHER_API_KEY = "d39c8748686afb6a55befcffbaa16554"

# ================== /start ==================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True,
        one_time_keyboard=True
    )

    await update.message.reply_text(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ğŸ‘‹\n\n"
        "Ğ¯ Ğ’Ğ°Ñˆ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº ğŸŒ¤\n"
        "ĞœĞ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ’Ğ°Ğ¼ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ² Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğµ.\n\n"
        "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«Ğ¡Ñ‚Ğ°Ñ€Ñ‚Â» ğŸ‘‡",
        reply_markup=reply_markup
    )


# ================== ĞºĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ñ‚Ğ°Ñ€Ñ‚" ==================
async def handle_start_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ğŸ‘\n\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°, Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ Ğ´Ğ»Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ’Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ ğŸŒ"
    )


# ================== Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ° (Ğ³Ğ¾Ñ€Ğ¾Ğ´) ==================
async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = update.message.text.title()  # Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾
    context.user_data["city"] = city

    # Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… 4 Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ¾Ğ²
    recent = context.user_data.get("recent_cities", [])
    if city in recent:
        recent.remove(city)
    recent.insert(0, city)
    if len(recent) > 4:
        recent = recent[:4]
    context.user_data["recent_cities"] = recent

    url = (
        "https://api.openweathermap.org/data/2.5/weather"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )
    response = requests.get(url)
    data = response.json()

    if response.status_code != 200:
        await update.message.reply_text(
            "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ‚Ğ°ĞºĞ¾Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸ˜”\n"
            "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·."
        )
        return

    temp = round(data["main"]["temp"])
    feels_like = round(data["main"]["feels_like"])
    humidity = data["main"]["humidity"]
    description = data["weather"][0]["description"]
    city_name = data["name"]

    await update.message.reply_text(f"Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ğ» Ğ³Ğ¾Ñ€Ğ¾Ğ´: {city_name} ğŸŒ")
    await show_menu(update, context)

    text = (
        f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ² {city_name}\n"
        f"{description.capitalize()}\n\n"
        f"ğŸŒ¡ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°: {temp}Â°C\n"
        f"ğŸ¤— ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº: {feels_like}Â°C\n"
        f"ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ: {humidity}%\n"
        f"â„¹ï¸ Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸ â€” Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿ÑƒĞ½ĞºÑ‚ Ğ½Ğ¸Ğ¶Ğµ ğŸ‘‡"
    )
    await update.message.reply_text(text)


# ================== /weather ==================
async def weather(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = " ".join(context.args) if context.args else "London"
    context.args = [city]
    await echo(update, context)


# ================== ĞœĞµĞ½Ñ ==================
async def show_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ¾Ğ²
    recent_cities = context.user_data.get("recent_cities", [])
    keyboard = [recent_cities] if recent_cities else []

    # ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
    keyboard += [
        ["ğŸ“Š Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°"],
        ["ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ"],
        ["ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"]
    ]

    reply_markup = ReplyKeyboardMarkup(
        keyboard=keyboard,
        resize_keyboard=True
    )

    await update.message.reply_text(
        "Ğ§Ñ‚Ğ¾ Ğ’Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑƒĞµÑ‚? ğŸ‘‡",
        reply_markup=reply_markup
    )


# ================== ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¼ĞµĞ½Ñ ==================
async def handle_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    city = context.user_data.get("city")

    if not city:
        await update.message.reply_text("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")
        return

    # ------------------ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ ------------------
    if text == "ğŸ“Š Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾" or text in context.user_data.get("recent_cities", []):
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        # Ğ£Ğ¼Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞ³Ğ¾ Ñ‡Ğ°ÑĞ°
        current = data["list"][0]
        smart_text = smart_weather_text(
            temp=round(current["main"]["temp"]),
            feels_like=round(current["main"]["feels_like"]),
            description=current["weather"][0]["description"],
            wind_speed=current["wind"]["speed"],
            day="ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ"
        )
        await update.message.reply_text(smart_text)

        # Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ¿Ğ¾ Ñ‡Ğ°ÑĞ°Ğ¼ Ñ ÑĞ¼Ğ¾Ğ´Ğ¶Ğ¸
        message = f"ğŸŒ¤ ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² {city}\n\n"
        target_hours = ["06:00", "09:00", "12:00", "15:00", "18:00", "21:00"]
        for item in data["list"]:
            time = item["dt_txt"][11:16]
            if time in target_hours:
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                emoji = get_weather_emoji(desc)
                message += f"ğŸ•’ {time} â€” {emoji} {temp}Â°C, {desc}\n"
        await update.message.reply_text(message)

    # ------------------ Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ° ------------------
    elif text == "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        tomorrow_date = (datetime.now() + timedelta(days=1)).strftime("%Y-%m-%d")
        target_hours = ["06:00", "09:00", "12:00", "15:00", "18:00", "21:00"]

        tomorrow_items = [
            item for item in data["list"]
            if item["dt_txt"].startswith(tomorrow_date)
        ]
        if not tomorrow_items:
            await update.message.reply_text("ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° ğŸ˜•")
            return

        # ÑƒĞ¼Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¾ĞºĞ¾Ğ»Ğ¾ ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ‹ Ğ´Ğ½Ñ
        main_item = tomorrow_items[len(tomorrow_items) // 2]
        smart_text = smart_weather_text(
            temp=round(main_item["main"]["temp"]),
            feels_like=round(main_item["main"]["feels_like"]),
            description=main_item["weather"][0]["description"],
            wind_speed=main_item["wind"]["speed"],
            day="Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°"
        )
        await update.message.reply_text(smart_text)

        # Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ¿Ğ¾ Ñ‡Ğ°ÑĞ°Ğ¼
        message = f"ğŸŒ… ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ² {city}\n\n"
        for item in tomorrow_items:
            time = item["dt_txt"][11:16]
            if time in target_hours:
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                emoji = get_weather_emoji(desc)
                message += f"ğŸ•’ {time} â€” {emoji} {temp}Â°C, {desc}\n"
        await update.message.reply_text(message)

    # ------------------ ĞĞ° 3 Ğ´Ğ½Ñ ------------------
    elif text == "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ":
        data = get_forecast(city)
        if not data:
            await update.message.reply_text("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ğŸ˜”")
            return

        days = {}
        target_hours = ["06:00", "12:00", "18:00"]
        for item in data["list"]:
            date, time = item["dt_txt"].split(" ")
            if time[:5] in target_hours:
                days.setdefault(date, []).append(item)

        message = f"ğŸ“… ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° 3 Ğ´Ğ½Ñ Ğ´Ğ»Ñ {city}\n\n"
        for date, items in list(days.items())[:3]:
            day_name = datetime.strptime(date, "%Y-%m-%d").strftime("%A")
            message += f"ğŸ“† {date} ({day_name})\n"
            for item in items:
                time = item["dt_txt"][11:16]
                temp = round(item["main"]["temp"])
                desc = item["weather"][0]["description"]
                emoji = get_weather_emoji(desc)
                message += f"   â€¢ {time} â€” {emoji} {desc}, {temp}Â°C\n"
            message += "\n"
        await update.message.reply_text(message)

    # ------------------ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ------------------
    elif text == "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´":
        context.user_data.pop("city", None)
        await update.message.reply_text("Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ ğŸ™‚ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ñ€Ğ¾Ğ´ ğŸŒ")


# ================== Ğ­Ğ¼Ğ¾Ğ´Ğ¶Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñ‹ ==================
def get_weather_emoji(description: str):
    description = description.lower()
    if "Ğ´Ğ¾Ğ¶Ğ´ÑŒ" in description:
        return "ğŸŒ§"
    elif "ÑĞ½ĞµĞ³" in description:
        return "â„ï¸"
    elif "Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ğ¾" in description:
        return "â˜ï¸"
    elif "ÑÑĞ½Ğ¾" in description:
        return "â˜€ï¸"
    elif "Ñ‚ÑƒĞ¼Ğ°Ğ½" in description:
        return "ğŸŒ«"
    else:
        return "ğŸŒ¡"


# ================== Ğ£Ğ¼Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ ==================
def smart_weather_text(temp, feels_like, description, wind_speed=None, day="ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ"):
    text = f"ğŸ§  Ğ§Ñ‚Ğ¾ Ğ¿Ğ¾ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸ÑĞ¼ {day}:\n"

    # Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°
    if temp <= 0:
        text += "â„ï¸ ĞÑ‡ĞµĞ½ÑŒ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾. "
    elif 1 <= temp <= 7:
        text += "ğŸ§¥ ĞŸÑ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ½Ğ¾. "
    elif 8 <= temp <= 15:
        text += "ğŸ™‚ ĞšĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚Ğ½Ğ¾, Ğ½Ğ¾ Ğ±ĞµĞ· Ğ¶Ğ°Ñ€Ñ‹. "
    elif 16 <= temp <= 25:
        text += "ğŸ˜Œ Ğ¢ĞµĞ¿Ğ»Ğ¾ Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾. "
    else:
        text += "ğŸ”¥ Ğ–Ğ°Ñ€ĞºĞ¾. "

    # ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº
    if feels_like < temp - 2:
        text += "ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ½Ğ¾ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½ĞµĞµ. "
    elif feels_like > temp + 2:
        text += "ĞŸĞ¾ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸ÑĞ¼ Ñ‚ĞµĞ¿Ğ»ĞµĞµ, Ñ‡ĞµĞ¼ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚ĞµÑ€Ğ¼Ğ¾Ğ¼ĞµÑ‚Ñ€. "

    # ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñ‹
    if "Ğ´Ğ¾Ğ¶Ğ´ÑŒ" in description:
        text += "ğŸŒ§ Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹ Ğ¾ÑĞ°Ğ´ĞºĞ¸ â€” Ğ·Ğ¾Ğ½Ñ‚ Ğ±ÑƒĞ´ĞµÑ‚ ĞºÑÑ‚Ğ°Ñ‚Ğ¸. "
    elif "ÑĞ½ĞµĞ³" in description:
        text += "â„ï¸ Ğ¡Ğ½ĞµĞ³ â€” Ğ±ÑƒĞ´ÑŒ Ğ¾ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶ĞµĞ½ Ğ½Ğ° Ğ´Ğ¾Ñ€Ğ¾Ğ³Ğµ. "
    elif "Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ğ¾" in description:
        text += "â˜ï¸ ĞŸĞ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾, ÑĞ¾Ğ»Ğ½Ñ†Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€ÑÑ‚Ğ°Ñ‚ÑŒÑÑ. "
    elif "ÑÑĞ½Ğ¾" in description:
        text += "â˜€ï¸ Ğ¯ÑĞ½Ğ¾ Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾. "
    elif "Ñ‚ÑƒĞ¼Ğ°Ğ½" in description:
        text += "ğŸŒ« Ğ¢ÑƒĞ¼Ğ°Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ½Ğ¸Ğ¶Ğ°Ñ‚ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ. "

    # Ğ’ĞµÑ‚ĞµÑ€
    if wind_speed:
        if wind_speed >= 8:
            text += "ğŸ’¨ Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²ĞµÑ‚ĞµÑ€ ÑƒÑĞ¸Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸Ñ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ°."
        elif wind_speed >= 4:
            text += "ğŸŒ¬ Ğ£Ğ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ‚ĞµÑ€."

    return text


# ================== ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ° ==================
def get_forecast(city: str):
    url = (
        "https://api.openweathermap.org/data/2.5/forecast"
        f"?q={city}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
    )
    response = requests.get(url)
    if response.status_code != 200:
        return None
    return response.json()


# ================== MAIN ==================
if __name__ == "__main__":
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Text(["Ğ¡Ñ‚Ğ°Ñ€Ñ‚"]), handle_start_button))
    app.add_handler(CommandHandler("weather", weather))
    app.add_handler(MessageHandler(
        filters.Text([
            "ğŸ“Š Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾", "ğŸŒ… Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°", "ğŸ“… ĞĞ° 3 Ğ´Ğ½Ñ", "ğŸ™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"
        ]), handle_menu))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo))

    app.run_polling()